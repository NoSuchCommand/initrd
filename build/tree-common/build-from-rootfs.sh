einfo "Building from rootfs"

root_mountpoint=$(mktemp -d)
rootfs=/tmp/rootfs.tar
rootfs_url=$(get_any rootfs_url)
[ -z "$rootfs_url" ] && die "No url to get the rootfs from provided"

pre_build() {
    einfo "Retrieving rootfs"
    run --abort wget -O $rootfs $rootfs_url
}

build() {
    einfo "Creating volume partitions"

    efi_part_uuid=$(uuidgen)
    root_part_uuid=$(uuidgen)
    run --abort sgdisk $volume -Z \
        -n 15:0:+100M -t 15:ef00 -c 15:efisystem -u 15:$efi_part_uuid \
        -n 1:0:0 -t 1:8300 -c 1:root -u 1:$root_part_uuid -p

    partx -u $volume

    root_device=$(sfdisk -d $volume | grep -i "$root_part_uuid" | cut -d':' -f1)
    efi_device=$(sfdisk -d $volume | grep -i "$efi_part_uuid" | cut -d':' -f1)

    einfo "Creating filesystems"

    mkfs.ext4 -L root $root_device
    mkfs.fat -F 32 $efi_device
    root_fs_uuid=$(blkid $root_device | tr " " "\n" | grep -E "^UUID=" | cut -d'=' -f2 | tr -d '"')
    efi_fs_uuid=$(blkid $efi_device | tr " " "\n" | grep -E "^UUID=" | cut -d'=' -f2 | tr -d '"')

    einfo "Mounting partitions"

    efi_mountpoint=$root_mountpoint/boot/efi
    mount $root_device $root_mountpoint
    mkdir -p $efi_mountpoint
    mkdir -p $root_mountpoint/boot/grub
    mount $efi_device $efi_mountpoint
    mkdir -p $efi_mountpoint/EFI/BOOT

    einfo "Installing rootfs to partitions"
    /bin/tar -C $root_mountpoint -xf $rootfs
    sync
    echo """# Generated by Scaleway's build system
PARTUUID=$root_part_uuid / ext4 rw,relatime 0 1
PARTUUID=$efi_part_uuid /boot/efi vfat rw,relatime,errors=remount-ro,nofail 0 2
""" > $root_mountpoint/etc/fstab

    einfo "Chrooting to bootstrap bootloader"
    mount -t proc proc $root_mountpoint/proc/
    mount -t sysfs sys $root_mountpoint/sys/
    mount -o bind /dev $root_mountpoint/dev/
    bootloader_install_path=$(chroot $root_mountpoint /bin/sh -c 'export PATH=$PATH:/usr/local/sbin/:/usr/local/bin; which scw-install-bootloader')
    if [ -x "$root_mountpoint/$bootloader_install_path" ]; then
        run --abort chroot $root_mountpoint $bootloader_install_path "root:$root_device:$root_part_uuid:$root_fs_uuid" "efi:$efi_device:$efi_part_uuid:$efi_fs_uuid"
    else
        eerror "Missing booloader install script 'scw-install-bootloader', did you mean to build unpartitioned ?"
    fi
    sync
}

post_build() {
    einfo "Unmounting image partitions"
    mountpoints=$(awk -v pattern="^$root_mountpoint" '$2 ~ pattern { print split($2, a, "/")-1 " " $2 }' /proc/mounts | sort -n -r | cut -d' ' -f2)
    for mountpoint in $mountpoints; do
        umount $mountpoint
    done
    devlayout=$(sgdisk -p $volume)
    if [ $? -eq 0 ]; then
        einfo "Final volume layout:"
        echo "$devlayout"
    fi
}
